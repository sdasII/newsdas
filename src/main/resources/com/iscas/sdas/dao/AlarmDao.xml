<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iscas.sdas.dao.AlarmDao">
	<select id="currentDayAlarm" resultType="com.iscas.sdas.dto.AlarmDto">
		SELECT
		a.cell_code,a.yyyyMMdd,COUNT(*) AS count,a.app_hour,a.app_result FROM
		(SELECT * FROM
		t_cell_result_info WHERE yyyyMMdd = (SELECT yyyyMMdd
		FROM
		t_cell_result_info ORDER BY yyyyMMdd DESC LIMIT 1)) AS a WHERE
		a.app_result=0 GROUP BY a.cell_code
	</select>
	<select id="allDayAlarm" resultType="com.iscas.sdas.dto.AlarmDto"
		parameterType="com.iscas.sdas.dto.AlarmDto">
		SELECT yyyyMMdd,cell_code,COUNT(*) AS count FROM t_cell_result_info
		WHERE app_result = 0
		<if test="cell_code !=null">
			<bind name="cellcode" value="'%'+ _parameter.getCell_code() +'%'" />
			and cell_code like #{cellcode}
		</if>
		<if test="starttime!=null and starttime!=null">
			and yyyyMMdd &gt;=#{starttime} and yyyyMMdd &lt;=#{endtime}
		</if>
		<if test="starttime==null and endtime==null and daynum==7">
			and TO_DAYS(NOW())-TO_DAYS(yyyyMMdd) &lt;=#{daynum}<!-- #{daynum} -->
		</if>
		<if test="starttime==null and endtime==null and daynum==30">
			and TO_DAYS(NOW())-TO_DAYS(yyyyMMdd) &lt;=#{daynum}
		</if>
		<if test="starttime==null and endtime==null and daynum==0">
			and TO_DAYS(NOW())-TO_DAYS(yyyyMMdd) =#{daynum}
		</if>
		GROUP BY cell_code,yyyyMMdd ORDER BY yyyyMMdd
	</select>
	<select id="alarmLastHour" resultType="com.iscas.sdas.dto.AlarmDto" 
			parameterType="com.iscas.sdas.dto.AlarmDto">
		SELECT * FROM t_cell_result_info WHERE app_hour= (SELECT
		app_hour FROM t_cell_result_info WHERE yyyyMMdd = (SELECT yyyyMMdd
		FROM t_cell_result_info ORDER BY yyyyMMdd DESC LIMIT 1) ORDER BY
		app_hour DESC LIMIT 1) AND yyyyMMdd = (SELECT yyyyMMdd FROM
		t_cell_result_info ORDER BY yyyyMMdd DESC LIMIT 1)
		<if test="app_result != null">
			and app_result = #{app_result}
		</if>
	</select>
	<select id="getLastDay" resultType="java.lang.String">
		SELECT yyyyMMdd FROM t_cell_result_info ORDER BY yyyyMMdd DESC LIMIT 1
	</select>
	<select id="getLastHour" resultType="java.lang.String">
		SELECT app_hour FROM t_cell_result_info WHERE yyyyMMdd = (SELECT yyyyMMdd
		FROM t_cell_result_info ORDER BY yyyyMMdd DESC LIMIT 1) ORDER BY app_hour DESC LIMIT 1
	</select>
	<select id="getLastDayInCell" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT yyyyMMdd FROM t_cell_result_info where cell_code = #{cellname} ORDER BY yyyyMMdd DESC LIMIT 1
	</select>
	<select id="getLastHourInCell" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT app_hour FROM t_cell_result_info WHERE cell_code = #{cellname} and yyyyMMdd = (SELECT yyyyMMdd
		FROM t_cell_result_info where cell_code = #{cellname} ORDER BY yyyyMMdd DESC LIMIT 1) ORDER BY app_hour DESC LIMIT 1
	</select>
	<!-- 最近一天健康预警（只筛选亚健康和事件） -->
	<!-- <select id="alarmLastDay" resultType="com.iscas.sdas.dto.AlarmDto" 
			parameterType="com.iscas.sdas.dto.AlarmDto">
		SELECT * FROM t_cell_result_info WHERE yyyyMMdd = (SELECT yyyyMMdd FROM
		t_cell_result_info where cell_code = #{cell_code} ORDER BY yyyyMMdd DESC LIMIT 1) and cell_code = #{cell_code} and (app_result=0||app_result=1)
	</select> -->
	<select id="cellListLastDay" resultType="com.iscas.sdas.dto.cell.CellResultHistoryDto"
	 	parameterType="java.lang.String">
		select * from t_cell_result_history where yyyyMMdd = (SELECT yyyyMMdd
		FROM t_cell_result_info ORDER BY yyyyMMdd DESC LIMIT 1)
		<if test="cellname!=null">
			<bind name="cellname" value="'%'+ cellname +'%'" />
			and cell_code like #{cellname}
		</if>
		<!-- <if test="result!=null">
			and range_00 = #{result} or range_01 = #{result} or range_02 = #{result} or range_03 = #{result}
			or range_04 = #{result} or range_05 = #{result} or range_06 = #{result} or range_07 = #{result} 
			or range_08 = #{result} or range_09 = #{result} or range_10 = #{result} or range_11 = #{result} 
			or range_12 = #{result} or range_13 = #{result} or range_14 = #{result} or range_15 = #{result}
			or range_16 = #{result} or range_17 = #{result} or range_18 = #{result} or range_19 = #{result}
			or range_20 = #{result} or range_21 = #{result} or range_22 = #{result} or range_23 = #{result}
			or range_24 = #{result}
		</if> -->
	</select>
	<select id="cellListLastWeek" parameterType="java.lang.String"
		resultType="com.iscas.sdas.dto.cell.CellResultHistoryDto">
		SELECT * FROM t_cell_result_history WHERE
		STR_TO_DATE(yyyyMMdd,'%Y%m%d') > DATE_SUB((SELECT yyyyMMdd FROM
		t_cell_result_history WHERE 1=1  
		<if test="cellname!=null">
			<bind name="cellname" value="'%'+ cellname +'%'" />
			and cell_code like #{cellname}
		</if>
		ORDER BY yyyyMMdd
		DESC LIMIT 1),INTERVAL 7 DAY) 
		<if test="cellname!=null">
			<bind name="cellname" value="'%'+ cellname +'%'" />
			and cell_code like #{cellname}
		</if>
		ORDER BY yyyyMMdd
	</select>
	<select id="cellListLastMonth" parameterType="java.lang.String"
		resultType="com.iscas.sdas.dto.cell.CellResultHistoryDto">
		SELECT * FROM t_cell_result_history WHERE
		STR_TO_DATE(yyyyMMdd,'%Y%m%d') > DATE_SUB((SELECT yyyyMMdd FROM
		t_cell_result_history WHERE 1=1  
		<if test="cellname!=null">
			<bind name="cellname" value="'%'+ cellname +'%'" />
			and cell_code like #{cellname}
		</if>
		ORDER BY yyyyMMdd
		DESC LIMIT 1),INTERVAL 30 DAY) 
		<if test="cellname!=null">
			<bind name="cellname" value="'%'+ cellname +'%'" />
			and cell_code like #{cellname}
		</if>
		ORDER BY yyyyMMdd
	</select>
	<select id="cellListBySelect" parameterType="java.lang.String"
		resultType="com.iscas.sdas.dto.cell.CellResultHistoryDto">
		SELECT * FROM t_cell_result_history WHERE
		STR_TO_DATE(yyyyMMdd,'%Y%m%d') BETWEEN #{start} AND #{end}
		<if test="cellname!=null">
			<bind name="cellname" value="'%'+ cellname +'%'" />
			and cell_code like #{cellname}
		</if>
		ORDER BY yyyyMMdd
	</select>
</mapper>
